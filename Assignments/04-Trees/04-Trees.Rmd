---
title: "Assignment 4: Decision Trees"
author: "Stat 434"
output: rmdformats::readthedown
---


# Instructions

You will submit an HTML document to Canvas as your final version.

You may work with **one** other person for this assignment.  Make sure both your names are on the HTML document, and you should **both** upload a copy of the assignment to Canvas.

Your document should show your code chunks/cells as well as any output.  Make sure that only relevant output is printed.  Do not, for example, print the entire dataset in your final knitted file.

Your document should also be clearly organized, so that it is easy for a reader to find your answers to each question.

There may be a small penalty for submissions that are difficult to read or navigate.

Libraries needed for this lab:

```{r, eval = FALSE}
library(tidyverse)
library(tidymodels)
library(rpart.plot)
library(discrim)
```




```{r, include = FALSE, eval = FALSE}
library(tidyverse)
library(tidymodels)
library(rpart.plot)
library(discrim)

set.seed(838)
# 
stars <- read_csv(here::here("Assignments", "data", "Stars.csv"))

stars <- stars %>%
  mutate(
    Type = factor(Type),
    Color = case_when(
      str_detect(Color, "Blue|Bluish") ~ "Blue",
      str_detect(Color, "Red") ~ "Red",
      str_detect(Color, "[Yy]ellow|Orange|[Ww]hit") ~ "Yellow"

    ),
    Color = factor(Color)
  )

stars %>%
  write_csv(here::here("Assignments", "data", "stars_cleaned.csv"))

tree_mod <- decision_tree() %>%
  set_engine("rpart") %>%
  set_mode("classification")

# lda_mod <- discrim_linear() %>%
#   set_engine("MASS") %>%
#   set_mode("classification")
# 
star_rec <- recipe(Type ~ ., data = stars)

star_cvs <- vfold_cv(stars, 5, strata = Type)

rf_mod <- rand_forest() %>%
  set_engine("ranger") %>%
  set_mode("classification")

rf_fit <- workflow() %>%
  add_recipe(star_rec) %>%
  add_model(rf_mod) %>%
  fit_resamples(star_cvs)

tree_fit <- workflow() %>%
  add_recipe(star_rec) %>%
  add_model(tree_mod) %>%
  fit_resamples(star_cvs)

# tree_fit %>% pull_workflow_fit() %$% fit %>%
#   rpart.plot()
# 
# lda_fit <- lda_mod %>%
#   fit(Color ~ ., data = stars)
# 
# nasa <- read_csv(here::here("Assignments", "data", "nasa.csv"))
# 
# nasa <- nasa %>%
#   mutate(
#     Hazardous = factor(Hazardous)
#   ) %>%
#   drop_na()
# 
# 
# nasa_rec <- recipe(Hazardous ~ ., data = nasa)
# 
# nasa_cvs <- vfold_cv(nasa, 5, strata = Hazardous)
# 
# tree_fit <- workflow() %>%
#   add_recipe(nasa_rec) %>%
#   add_model(tree_mod) %>%
#   fit_resamples(nasa_cvs)
# 
# 
# tree_fit <- tree_mod %>%
#   fit(Hazardous ~ ., data = nasa)
# 
# tree_fit$fit %>%
#   rpart.plot()

shrooms <- read_csv(here::here("Assignments", "data", "mushrooms.csv"), 
                    col_types = str_c(rep("c", 23), collapse = "")) %>%
  mutate_all(factor)

tree_fit <- tree_mod %>%
  fit(class ~ ., data = shrooms)

tree_fit$fit %>%
  rpart.plot()


rf_fit <- workflow() %>%
  add_recipe(recipe(class ~ ., data = shrooms)) %>%
  add_model(rf_mod) %>%
  fit_resamples(vfold_cv(shrooms, 5))



tele <- read_csv(here::here("Assignments", "data", "Telecust1.csv")) %>%
  mutate(
    custcat = factor(custcat)
  )
                 
                 
tree_fit <- tree_mod %>%
  fit(custcat ~ ., data = tele)

tree_fit$fit %>%
  rpart.plot()

```


# Dataset 1:  Mushrooms

The first dataset we will study today concerns mushrooms that grow in the wild.
An expert mushroom forager can identify the species by its appearance, and determine
if the mushroom is edible or poisonous.  

Can we train a model to do the same?

Read the data in as follows.  (You do need the extra bit of code in the `read_csv` function, make sure you copy it over.)

```{r, eval = FALSE}
mushrooms <- read_csv("https://www.dropbox.com/s/jk5q3dq1u63ey1e/mushrooms.csv?dl=1",
                      col_types = str_c(rep("c", 23), collapse = "")) 

```

You can find further documentation of the dataset here: https://www.kaggle.com/uciml/mushroom-classification

## Part One: A perfect tree

Fit a single decision tree to the full mushroom data, and plot the resulting tree.

You should find that all mushrooms are perfectly classified; that is, the resulting leaf nodes are all 100% pure.

Based on the tree that results, suggest a "nature guide" that tells people which mushrooms are safe to eat and which aren't.


## Part Two: ... or is it?

Before we send people off into the world to each poisonous mushrooms, we want to be confident of our guidelines.  The decision tree in Q1 may achieve perfection on the data it is fit to, but do we believe these guidelines will hold for future data?

Apply each of the following resampling and/or ensemble techniques to this classification problem.  For each, make an argument from the results.

You should either argue that 

(a) The classification rules we learned in Part One probably apply to all mushrooms; or

(b) The classification rules we learned in Part One are overfit to this particular sample of mushrooms and/or set off predictors.

#### Q1: Cross-validation

#### Q2: Bagging

#### Q3: Random forests


## Part Three:  Logistic Regression

Fit a logistic regression, including only the predictors that you deem most important based on your work in Parts One and Two.

Interpret the results:  which features of a mushroom are most indicative of poisonness?



# Dataset 2:  Telecom Customers

Congratulations!  You have been hired by the Data Science division of a major telecommunication company.

The Sales division of the company wants to understand how customer demographics - such as their age, income, marital status, employment status, etc - impact the customer's behavior.  They have identified four different types of customers, and labeled a dataset of existing customers with these categories.

```{r, eval = FALSE}
tele <- read_csv("https://www.dropbox.com/s/9dymy30v394ud8h/Telecust1.csv?dl=1")
```

Further documentation of this data can be found here: 
https://www.kaggle.com/prathamtripathi/customersegmentation


You've been tasked with studying the customer demographics and customer categories.  The company would like two results from you:

1. A model that can be used to predict what category a new customer who signs up will likely fall into.

2. Insight into what demographics are associated with these customer differences.

#### Part Four:  Report to your manager

Your manager, the head of the Data Science department, would like a summary of your work.  

She does not need to see every single detail of every step of your process, but she does need to know a basic outline of what you tried, how you made your decisions, and why you settled on certain choices.

You should share only as much of your code and results as you feel is necessary for her to get the "big picture" of your approach.  You can assume she has taken Stat 434, and you may use any "lingo" you want; for example, you can reference the Gini Index without having to explain what it is.

#### Part Five: Report to Sales

Now that your manager has approved your work, you're ready to present the results to Sales.

The Sales team has zero Data Science training.  They have some understanding of things like percentages, means, and medians - but they do not know or care about modeling details.

Summarize the results of your work in a way that is understandable to the Sales team, and only contains the level of technical detail that they might need to properly use the results in their job.  You should NOT use any lingo.  For example, instead of saying "We chose the model with highest precision", you should say, "We chose the model that was least likely to misclassify an A-type customer as B-type."


## Challenge: Professionalism

For **5 challenge points**, convert your Part Five writeup into a standalone document, that is as professionally presented as possible.  Submit this to the Challenge 4 assignment.

For **5 additional challenge points**, include in your writeup at least one plot that helps highlight the important takeaway messages of your modeling process.   

I will give out additional extra challenge points for writeups that impress me.  Remember, longer is not necessarily better!  You are not trying to make the audience think, "Wow, they are so smart!" You are trying to communicate and justify the conclusions of your analysis in the clearest possible way to a non-expert.